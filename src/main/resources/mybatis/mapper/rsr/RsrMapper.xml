<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.vpplab.flow.domain.rsr.RsrDao">
    <select id="getClcRsrList" parameterType="hashMap" resultType="hashMap">
        SELECT
            CC.집합자원ID
            ,CC.중개사업자ID
            ,CC.집합자원그룹명
            ,CC.집합자원구분
            ,CC.운영상태
            ,CC.신청유형
            ,CC.처리상태
            ,CC.구성수
            ,CC.자원용량
            ,CC.PVWT용량
            ,CC.ESS용량
            ,CC.평균오차율
            ,CC.오차율평가
            ,CC.거래가능기간
            ,CC.신청일자
            FROM(SELECT
                    A.id AS 집합자원ID
                    ,A.agency_id AS 중개사업자ID
                    ,A.name AS 집합자원그룹명
                    ,A.type AS 집합자원구분
                    ,A.status AS 운영상태
                    ,A.apply_type AS 신청유형
                    ,A.apply_status AS 처리상태
                    ,SUM(B.resource_cnt) AS 구성수
                    ,SUM(B.capacity) AS 자원용량
                    ,SUM(B.capacity01) AS PVWT용량
                    ,SUM(B.capacity04) AS ESS용량
                    ,'' AS 평균오차율
                    ,'' AS 오차율평가
                    ,'' AS 거래가능기간
                    ,A.created_at AS 신청일자
                FROM resource_set A
                LEFT OUTER JOIN ( SELECT
                                    AA.resource_set_id
                                    ,COUNT(resource_id) AS  resource_cnt
                                    ,SUM(BB.capacity) AS capacity
                                    ,CASE WHEN BB.facility_type ='01' OR BB.facility_type = '02' THEN SUM(BB.capacity) END AS capacity01
                                    ,CASE WHEN BB.facility_type ='04' THEN SUM(BB.capacity) END AS capacity04
                                FROM resource_set_list AA
                                LEFT OUTER JOIN resource BB ON AA.resource_id = BB.id  GROUP BY BB.id) B ON A.id = B.resource_set_id) CC
        WHERE 1=1
        AND CC.중개사업자ID = #{중개사업자ID}
        <if test="'집합자원그룹명' != null and '집합자원그룹명' !=''">
            AND CC.집합자원그룹명 LIKE CONCAT('%',#{집합자원그룹명},'%')
        </if>
        ORDER BY CC.집합자원ID
        LIMIT #{페이지번호},#{행갯수}
    </select>
    <select id="getClcRsrListCnt" parameterType="hashMap" resultType="int" >
        SELECT
          COUNT(*) AS cnt
        FROM(SELECT
                A.id AS 집합자원ID
                ,A.agency_id AS 중개사업자ID
                ,A.name AS 집합자원그룹명
                ,A.type AS 집합자원구분
                ,A.status AS 운영상태
                ,A.apply_type AS 신청유형
                ,A.apply_status AS 처리상태
                ,SUM(B.resource_cnt) AS 구성수
                ,SUM(B.capacity) AS 자원용량
                ,SUM(B.capacity01) AS PVWT용량
                ,SUM(B.capacity04) AS ESS용량
                ,'' AS 평균오차율
                ,'' AS 오차율평가
                ,'' AS 거래가능기간
                ,A.created_at AS 신청일자
            FROM resource_set A
                LEFT OUTER JOIN ( SELECT
                                    AA.resource_set_id
                                    ,COUNT(resource_id) AS  resource_cnt
                                    ,SUM(BB.capacity) AS capacity
                                    ,CASE WHEN BB.facility_type ='01' OR BB.facility_type = '02' THEN SUM(BB.capacity) END AS capacity01
                                    ,CASE WHEN BB.facility_type ='04' THEN SUM(BB.capacity) END AS capacity04
                                FROM resource_set_list AA
                                LEFT OUTER JOIN resource BB ON AA.resource_id = BB.id  GROUP BY BB.id) B ON A.id = B.resource_set_id) CC
        WHERE 1=1
        AND CC.중개사업자ID = #{중개사업자ID}
        <if test="'집합자원그룹명' != null and '집합자원그룹명' !=''">
            AND CC.집합자원그룹명 LIKE CONCAT('%',#{집합자원그룹명},'%')
        </if>
    </select>

</mapper>